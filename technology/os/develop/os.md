# 简介

本文用于记录 OS 中的一些笔记

# 硬件

## 接口

[**串行端口**](https://en.wikipedia.org/wiki/Serial_port)

串行端口是一次只能传输一位的端口。 在 20 世纪末，它的缺点是传输速度慢，但从 21 世纪初开始，它通过增加数据传输频率来提高数据传输速度。

[**并行端口**](https://en.wikipedia.org/wiki/Parallel_port)

并行端口是一次可以传输多个位的端口。 20世纪末，它的传输速度比串口还快，得到了广泛的应用。 但它有一个缺陷，它必须同时发送多位数据，多位数据也必须同时到达，如果一位数据丢失，则必须重新发送多位数据。

[**USB**](https://en.wikipedia.org/wiki/USB)

串行和并行端口已在很大程度上被 USB 端口所取代。 USB 本质上是对串行端口的改进，其接口内部有多个串行端口，称为端点。

USB 也可以并行传输，但与并行端口不同的是，如果在传输过程中数据丢失，则不需要重新发送所有数据。

例如，如果同时发送8位数据，如果一位发送失败，则并口需要重新发送8位数据，而USB只需要重新发送丢失的位数据。

每个 USB 端口都有一个对应的编号。 默认端口 0 作为控制端口，用于传输控制命令。 USB 主机可以通过命令指定使用哪些端口进行传输。

# OS 基本概念

## 内核模式和用户模式

内核模式和用户模式是相对于 CPU 而言的。 内核模式是指运行在特权级别 0 的 CPU，而用户模式是指运行在特权级别 3 的 CPU。

用户进程进入内核态：表示当前进程由于来自内核或外部的中断而暂时终止执行，并在中断程序保存其上下文后开始执行一段内核代码。

应用程序可以直接跨标准库执行系统调用。 对于Linux系统，直接嵌入汇编代码`int 0x80`即可直接执行系统调用。 当然，系统调用子函数号要提前准备好，子函数号使用寄存器`eax`存储。

## [x86 内存分段](https://zh.wikipedia.org/zh-cn/X86%E8%A8%98%E6%86%B6%E9%AB%94%E5%8D%80%E6%AE%B5)

x86 架构的 CPU，使用段基地址 + 段内偏移的方式访问内存，并不是直接使用物理地址访问内存。段基地址存储于各个段寄存器中：

* 代码段寄存器 CS 与寄存器IP相配合获得当前线程代码执行到的内存位置
* 数据段寄存器 DS 与各通用寄存器配合访问内存中的数据
* 栈段寄存器 SS 与寄存器 (E)SP、(E)BP 配合访问线程的调用栈（call stack）
* 扩展段寄存器 ES 用于特定字符串指令（如 MOVS 或 CMPS）。
* 80386引入了2个额外的段寄存器 FS 与 GS，并无特定的硬件用途。

由于因特尔 8086 CPU 的段寄存器是16位的，只能访问 64 KB 内存，而内存地址总线是20位的，可以访问 1 MB 内存，因此，内存物理地址的计算公式为：物理地址 = 段基址 \* 16 + 段内偏移地址。

## [实模式和保护模式](https://zh.wikipedia.org/zh-cn/X86%E8%A8%98%E6%86%B6%E9%AB%94%E5%8D%80%E6%AE%B5#80286%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F)

> Intel 80286 处理器仍然使用 16 位段寄存器与 16 位的段内偏移地址，但保护模式下支持访问 224（16M）字节的内存。16 位段寄存器内不再是段地址，**16 位段寄存器的高 13 位被称作段选择符（segment selector），其值是到段描述符表的索引值。**段描述符中包含了 24 位的段开始的基地址，20 位的段长度。段开始地址与段内偏移地址相加即为内存物理地址。段的长度上限为 220 = 1M 字节。
>
> Intel 80386 处理器继续使用 286 的分段保护模式，但段描述符中包含了 32 位的段开始的基地址。段内偏移地址也是 32 位。在分段转址与物理地址之间又增加了一层**分页（paging）转址**。分段寻址是不能关闭的。分页可以使能或关闭（enabled or disabled），如果关闭就与 286 保护模式一样。**如果使用分页机制，则由段开始的基地址与段内偏移地址相加得到的是线性地址（虚地址），线性地址还需要分页转址才得到内存物理地址。**

## 电脑启动时的加载顺序

在主板接通电源后，CPU 会首先从主板的固件中，加载 BIOS 程序到地址 0xF0000～0xFFFFF 处，入口地址是 0xFFFF0。BIOS 会自动完成所有设备的开机自检，以及 USB 等外设的初始化工作，随后 BIOS 会读取各个存储器设备中，第一个扇区的 512 个字节，如果这 512 个字节的最后两个字节是 0x55 和 0xAA，BIOS 就会认为前 510 个字节为 [MBR 主引导记录](mbr.md)，会将其加载到 0x7C00 处，并开始执行 MBR 程序，由 MBR 负责启动操作系统的主引导器。

